<?xml version="1.0" ?>
<robot name="ack" xmlns:xacro="http://ros.org/wiki/xacro">
  
  <!-- Parameters -->
   <xacro:property name="M_PI" value="3.14159265359"/>

   <xacro:property name="max_steering_angle" value="0.5"/> <!-- 28.65 grader -->
   <xacro:property name="max_velocity" value="0.6"/>
   <xacro:property name="max_wheel_angular_velocity" value="${2 * max_velocity/0.067}"/> <!-- Wheel diameter = 0.067 -->


  <material name="black">
    <color rgba="0 0 0 1"/>
  </material>
  <!-- base_link -->
  <link name="base_link">
    <inertial>
      <origin rpy="0 0 0" xyz="-0.00186669751054189 3.0253386351986E-05 -0.00605296088229322"/>
      <mass value="0.0961047465616957"/>
      <inertia ixx="8.55867486364231E-05" ixy="3.41346959938296E-08" ixz="1.64755227278164E-05" iyy="0.000277248181555496" iyz="-2.95282759133104E-08" izz="0.000344246448853775"/>
    </inertial>
    <visual>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <geometry>
        <mesh filename="models://acker/base_link.STL"/>
      </geometry>
      <material name="">
        <color rgba="0.3 0.3 0.3 1"/>
      </material>
    </visual>
    <collision>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <geometry>
        <mesh filename="models://acker/base_link.STL"/>
      </geometry>
    </collision>
  </link>

  <!-- base_footprint -->
  <link name="base_footprint"/>

  <!-- base_footprint to base_link -->
  <joint name="base_footprint_to_base_link" type="fixed">
    <parent link="base_footprint"/>
    <child link="base_link"/>
    <origin xyz="0 0 0.07" rpy="0 0 0"/>
  </joint>

  <!-- Wheel links-->
  <link name="wheel_lf_Link">
    <inertial>
      <origin rpy="0 0 0" xyz="1.65897579444685E-06 -0.00270913022688685 -1.5546673051009E-06"/>
      <mass value="0.0252873083503169"/>
      <inertia ixx="1.00371783485335E-05" ixy="4.93900109379125E-11" ixz="7.42104604492639E-10" iyy="1.67620175120314E-05" iyz="-5.47583950457701E-11" izz="1.00370342405297E-05"/>
    </inertial>
    <visual>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <geometry>
        <mesh filename="models://acker/wheel_lf_Link.STL"/>
      </geometry>
      <material name="">
        <color rgba="0.2 0.2 0.2 1"/>
      </material>
    </visual>
    <collision>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <geometry>
        <mesh filename="models://acker/wheel_lf_Link.STL"/>
      </geometry>
    </collision>
  </link>
  <joint name="wheel_lf_Joint" type="continuous">
    <origin rpy="0 0 0" xyz="0.06679 0.069739 -0.0288"/>
    <parent link="base_link"/>
    <child link="wheel_lf_Link"/>
    <axis xyz="-2.2918E-05 1.9551E-05 1"/>
  </joint>

  <link name="wheel_rf_Link">
    <inertial>
      <origin rpy="0 0 0" xyz="-1.48986965733955E-06 0.0027090575018239 1.16299057125596E-06"/>
      <mass value="0.0252873548617242"/>
      <inertia ixx="1.00360241846408E-05" ixy="-5.83065201444192E-11" ixz="-8.3023958781985E-11" iyy="1.67622954977732E-05" iyz="6.31638512668579E-11" izz="1.00384960556047E-05"/>
    </inertial>
    <visual>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <geometry>
        <mesh filename="models://acker/wheel_rf_Link.STL"/>
      </geometry>
      <material name="">
        <color rgba="0.2 0.2 0.2 1"/>
      </material>
    </visual>
    <collision>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <geometry>
        <mesh filename="models://acker/wheel_rf_Link.STL"/>
      </geometry>
    </collision>
  </link>
  <joint name="wheel_rf_Joint" type="continuous">
    <origin rpy="0 0 0" xyz="0.066794 -0.069739 -0.028803"/>
    <parent link="base_link"/>
    <child link="wheel_rf_Link"/>
    <axis xyz="-2.2918E-05 1.9551E-05 1"/>
  </joint>

  <link name="wheel_lb_Link">
    <inertial>
      <origin rpy="0 0 0" xyz="1.62806317080544E-06 -0.00317716794378092 -1.54238045318306E-06"/>
      <mass value="0.0271078161230754"/>
      <inertia ixx="1.01056035703468E-05" ixy="4.60479373806495E-11" ixz="7.43896782806142E-10" iyy="1.67990600599721E-05" iyz="-5.763890541079E-11" izz="1.01072652738793E-05"/>
    </inertial>
    <visual>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <geometry>
        <mesh filename="models://acker/wheel_lb_Link.STL"/>
      </geometry>
      <material name="">
        <color rgba="0.2 0.2 0.2 1"/>
      </material>
    </visual>
    <collision>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <geometry>
        <mesh filename="models://acker/wheel_lb_Link.STL"/>
      </geometry>
    </collision>
  </link>
  <joint name="wheel_lb_Joint" type="continuous">
    <origin rpy="0 0 0" xyz="-0.070313 0.07014 -0.027793"/>
    <parent link="base_link"/>
    <child link="wheel_lb_Link"/>
    <axis xyz="-2.2787E-05 1 1.9439E-05"/>
  </joint>

  <link name="wheel_rb_Link">
    <inertial>
      <origin rpy="0 0 0" xyz="-1.50804700475154E-06 0.00317707027691583 1.18963606317302E-06"/>
      <mass value="0.0271078005024283"/>
      <inertia ixx="1.01044417409685E-05" ixy="-5.83069005452564E-11" ixz="-7.56886841840775E-11" iyy="1.67993271276785E-05" iyz="6.31638424138502E-11" izz="1.01087182681654E-05"/>
    </inertial>
    <visual>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <geometry>
        <mesh filename="models://acker/wheel_rb_Link.STL"/>
      </geometry>
      <material name="">
        <color rgba="0.2 0.2 0.2 1"/>
      </material>
    </visual>
    <collision>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <geometry>
        <mesh filename="models://acker/wheel_rb_Link.STL"/>
      </geometry>
          </collision>
  </link>
  <joint name="wheel_rb_Joint" type="continuous">
    <origin rpy="0 0 0" xyz="-0.07031 -0.07014 -0.027796"/>
    <parent link="base_link"/>
    <child link="wheel_rb_Link"/>
    <axis xyz="-2.2787E-05 1 1.9439E-05"/>
  </joint>

  <joint name="lidar_Joint" type="fixed">
    <origin rpy="0 0 0" xyz="-0.0096019 -8.533E-05 0.092501"/>
    <parent link="base_link"/>
    <child link="lidar_frame"/>
    <axis xyz="0 0 0"/>
  </joint>
  <link name="lidar_frame">
    <inertial>
      <origin rpy="0 0 0" xyz="8.65086433231368E-05 9.02624784523964E-05 -0.0183546134614858"/>
      <mass value="0.0405423044068563"/>
      <inertia ixx="4.98470776877503E-06" ixy="-1.54076264166869E-07" ixz="2.05182706824286E-09" iyy="5.03926730822203E-06" iyz="1.1006285118993E-08" izz="8.25645669548359E-06"/>
    </inertial>
    <visual>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <geometry>
        <mesh filename="models://acker/lidar_Link.STL"/>
      </geometry>
      <material name="">
        <color rgba="0.1 0.1 0.1 1"/>
      </material>
    </visual>
    <collision>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <geometry>
        <mesh filename="models://acker/lidar_Link.STL"/>
      </geometry>
    </collision>
  </link>


  <xacro:include filename="$(find rc_gazebo)/urdf/imu.urdf.xacro"/>


  <!-- Gazebo Control -->
  <ros2_control name="ack_control" type="system">
    <hardware>
      <plugin>gz_ros2_control/GazeboSimSystem</plugin>
    </hardware>

    <!-- Front wheels (steering joints) -->
    <joint name="wheel_lf_Joint">
      <command_interface name="position">
        <param name="min">${-max_steering_angle}</param>
        <param name="max">${max_steering_angle}</param>
      </command_interface>

      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>

    <joint name="wheel_rf_Joint">
      <command_interface name="position">
        <param name="min">${-max_steering_angle}</param>
        <param name="max">${max_steering_angle}</param>
      </command_interface>

      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>

    <!-- Rear wheels (drive joints) -->
    <joint name="wheel_lb_Joint">
      <command_interface name="velocity">
        <param name="min">${-max_wheel_angular_velocity}</param>
        <param name="max">${max_wheel_angular_velocity}</param>
      </command_interface>

      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>

    <joint name="wheel_rb_Joint">
      <command_interface name="velocity">
        <param name="min">${-max_wheel_angular_velocity}</param>
        <param name="max">${max_wheel_angular_velocity}</param>
      </command_interface>

      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>
  </ros2_control>

  <gazebo>
    <plugin filename="gz-sim-joint-state-publisher-system"
            name="gz::sim::systems::JointStatePublisher">
      <topic>joint_states</topic>
      <joint_name>wheel_lf_Joint</joint_name>
      <joint_name>wheel_rf_Joint</joint_name>
      <joint_name>wheel_lb_Joint</joint_name>
      <joint_name>wheel_rb_Joint</joint_name>
    </plugin>

    <plugin filename="gz_ros2_control-system"
            name="gz_ros2_control::GazeboSimROS2ControlPlugin">
      <parameters>$(find rc_gazebo)/config/gz_ros2_control.yaml</parameters>
    </plugin>
  </gazebo>


  <!-- Sensorer -->
  <!-- <gazebo>
    <plugin name='gz::sim::systems::Sensors' filename='gz-sim-sensors-system'>
      <render_engine>ogre2</render_engine>
    </plugin>
  </gazebo> -->

  <gazebo reference="lidar_frame">
    <sensor name="lidar_sensor" type="gpu_lidar">
      <always_on>true</always_on>
      <update_rate>10</update_rate>
      <visualize>true</visualize>
      <topic>/sensors/lidar/raw</topic>
      <enable_metrics>false</enable_metrics>
      <pose relative_to="lidar_frame"> 0 0 0 0 0 3.14159265359 </pose>
      <lidar>
        <scan>
          <horizontal>
            <samples>450</samples>
            <resolution>1</resolution>
            <min_angle>-3.14159265359</min_angle>
            <max_angle>3.14159265359</max_angle>
          </horizontal>
        </scan>
        <range>
          <min>0.05</min>
          <max>20</max>
          <resolution>0.01</resolution>
        </range>
        <noise>
          <type>gaussian</type>
          <mean>0</mean>
          <stddev>0</stddev>
        </noise>
      </lidar>
    </sensor>
  </gazebo>

</robot>
